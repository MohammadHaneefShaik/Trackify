
<head>
  <script src="/socket.io/socket.io.js"></script>
</head>

<% if (!user) { %>

<div class="alert alert-info text-center shadow-sm">
  Please <a href="/auth/login" class="fw-semibold text-decoration-none">Login</a> to track buses.
</div>

<% } else { %>

<!-- üîµ Search + Bus Selection Card -->
<div class="card p-3 shadow-lg border-0 mb-4" style="border-radius: 16px;">
  <h5 class="fw-semibold text-secondary mb-3">üöå Select Bus</h5>

  <!-- üîç Search Bar -->
  <div class="mb-3">
    <label class="form-label fw-semibold text-dark">Search Bus:</label>
    <input 
      type="text" 
      id="searchBus" 
      class="form-control shadow-sm border-0 rounded-3 p-2"
      placeholder="Search bus number..."
    />
  </div>

  <!-- üîµ Search Results List -->
  <ul id="busResults" class="list-group shadow-sm" style="cursor: pointer;"></ul>
</div>

<!-- üü© Map Card -->
<div class="card p-3 shadow-lg border-0" style="border-radius: 16px;">
  <h5 class="fw-semibold text-secondary mb-3">üìç Live Bus Tracking</h5>

  <div id="map" data-stops='<%- JSON.stringify(stops) %>'
    style="height: 450px; border-radius: 14px; border: 1px solid #ddd;" class="shadow-sm">
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  const map = L.map("map").setView([15.8281, 78.0373], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const stopsElement = document.getElementById("map");
  const allStops = JSON.parse(stopsElement.dataset.stops || "[]");

  const socket = io({ withCredentials: true });
  let selectedBusId = null;
  let marker = null;
  let stopMarkers = [];

  // bus list
  const busList = <%- JSON.stringify(buses) %>;

  const busResults = document.getElementById("busResults");

  // üîç LIVE SEARCH (NO DROPDOWN)
  document.getElementById("searchBus").addEventListener("input", function () {
    const query = this.value.toLowerCase().trim();
    busResults.innerHTML = "";

    if (!query) return;

    const filtered = busList.filter(bus =>
      bus.busNumber.toLowerCase().includes(query)
    );

    if (filtered.length === 0) {
      busResults.innerHTML = `<li class="list-group-item">No buses found</li>`;
      return;
    }

    filtered.forEach(bus => {
      const li = document.createElement("li");
      li.className = "list-group-item fw-semibold";
      li.textContent = bus.busNumber;
      li.onclick = () => selectBus(bus._id, bus.busNumber);
      busResults.appendChild(li);
    });
  });

  // When user selects bus from results
  function selectBus(busId, busNumber) {
    selectedBusId = busId;
    localStorage.setItem("selectedBusId", busId);

    document.getElementById("searchBus").value = busNumber;
    busResults.innerHTML = "";

    showNotification(`üöç Tracking started for <b>${busNumber}</b>`);
    showStopsForBus(busId);
  }

  // remove markers
  function clearStops() {
    stopMarkers.forEach(m => map.removeLayer(m));
    stopMarkers = [];
  }

  // show stops
  function showStopsForBus(busId) {
    clearStops();
    const filteredStops = allStops.filter(stop => stop.busId === busId);

    if (filteredStops.length === 0) {
      showNotification("‚ö†Ô∏è No stops found for this bus!");
      return;
    }

    filteredStops.forEach(stop => {
      const stopMarker = L.marker([stop.latitude, stop.longitude], {
        icon: L.icon({
          iconUrl: "/images/stop.png",
          iconSize: [30, 30],
          iconAnchor: [15, 30]
        })
      }).addTo(map).bindPopup(`<b>${stop.stopName}</b>`);

      stopMarkers.push(stopMarker);
    });

    const group = L.featureGroup(stopMarkers);
    map.fitBounds(group.getBounds().pad(0.2));
  }

  // restore last bus
  window.addEventListener("load", () => {
    const savedBusId = localStorage.getItem("selectedBusId");
    if (savedBusId) {
      selectedBusId = savedBusId;
      const savedBus = busList.find(b => b._id === savedBusId);
      if (savedBus) {
        document.getElementById("searchBus").value = savedBus.busNumber;
        showStopsForBus(savedBusId);
        showNotification(`üîÑ Resumed tracking for <b>${savedBus.busNumber}</b>`);
      }
    }
  });

  // live tracking
  socket.on("receive-location", ({ busId, latitude, longitude }) => {
    if (selectedBusId !== String(busId)) return;

    if (!marker) {
      marker = L.marker([latitude, longitude], {
        icon: L.icon({
          iconUrl: "/images/bus.png",
          iconSize: [42, 42],
          iconAnchor: [20, 42],
        }),
      }).addTo(map);
    } else {
      marker.setLatLng([latitude, longitude]);
    }

    map.setView([latitude, longitude], 15);

    const filteredStops = allStops.filter(stop => stop.busId === selectedBusId);
    const reachedStop = filteredStops.find(
      stop =>
        Math.abs(stop.latitude - latitude) < 0.0008 &&
        Math.abs(stop.longitude - longitude) < 0.0008
    );

    if (reachedStop) {
      showNotification(`üöå Bus reached <b>${reachedStop.stopName}</b>`);
    }
  });

  function showNotification(message) {
    const popup = document.createElement("div");
    popup.innerHTML = message;
    popup.style.position = "fixed";
    popup.style.bottom = "20px";
    popup.style.right = "20px";
    popup.style.background = "#00a5c6";
    popup.style.color = "white";
    popup.style.padding = "12px 18px";
    popup.style.borderRadius = "10px";
    popup.style.fontWeight = "500";
    popup.style.boxShadow = "0 4px 12px rgba(0,0,0,0.3)";
    popup.style.zIndex = "9999";
    popup.style.transition = "opacity 0.5s ease";
    document.body.appendChild(popup);
    setTimeout(() => {
      popup.style.opacity = "0";
      setTimeout(() => popup.remove(), 500);
    }, 3000);
  }
</script>

<% } %>

<style>
  #searchBus {
    background: rgba(255, 255, 255, 0.65);
    backdrop-filter: blur(8px);
    border-radius: 14px;
    border: 1px solid #ddd;
    padding: 10px;
  }

  #searchBus:focus {
    border-color: #00b4d8;
    box-shadow: 0 0 8px rgba(0, 180, 216, 0.6);
  }

  .list-group-item:hover {
    background: #e0f7ff;
  }
</style>
