<head>
<script src="/socket.io/socket.io.js"></script>
</head>

<% if (!user) { %>
<div class="alert alert-info text-center shadow-sm">
  Please <a href="/auth/login" class="fw-semibold text-decoration-none">Login</a> to track buses.
</div>
<% } else { %>

<!-- üöå Bus Selection Card -->
<div class="card p-3 shadow-lg border-0 mb-4" style="border-radius: 16px;">
  <h5 class="fw-semibold text-secondary mb-3">üöå Select Bus</h5>

  <div class="mb-3">
    <label class="form-label fw-semibold text-dark">Bus Number:</label>
    <select id="busSelect" class="form-select shadow-sm border-0 rounded-3 p-2">
      <option value="">-- Choose Bus --</option>
      <% buses.forEach(bus=> { %>
        <option value="<%= bus._id %>">
          <%= bus.busNumber %>
        </option>
      <% }) %>
    </select>
  </div>

  <button id="viewBtn" class="btn w-100 py-2 fw-semibold text-white"
    style="background-color: #00b4d8; border-radius: 10px;" disabled>
    üöç View Bus Location
  </button>
</div>

<!-- üìç Live Tracking Card -->
<div class="card p-3 shadow-lg border-0" style="border-radius: 16px;">
  <h5 class="fw-semibold text-secondary mb-3">üìç Live Bus Tracking</h5>

  <div id="map" data-stops='<%- JSON.stringify(stops) %>'
    style="height: 450px; border-radius: 14px; border: 1px solid #ddd;" class="shadow-sm"></div>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  // ===========================
  // MAP INITIALIZATION (same as driver)
  // ===========================
  const map = L.map("map").setView([15.8281, 78.0373], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const stopsElement = document.getElementById("map");
  const allStops = JSON.parse(stopsElement.dataset.stops || "[]");

  const socket = io({ withCredentials: true });

  let selectedBusId = null;
  let marker = null;
  let stopMarkers = [];

  const busSelect = document.getElementById("busSelect");
  const viewBtn = document.getElementById("viewBtn");

  // ===========================
  // CLEAR STOPS
  // ===========================
  function clearStops() {
    stopMarkers.forEach(m => map.removeLayer(m));
    stopMarkers = [];
  }

  // ===========================
  // DISPLAY STOPS (NO ROUTE LINE)
  // ===========================
  function showStopsForBus(busId) {
    clearStops();

    const filteredStops = allStops.filter(stop => stop.busId === busId);

    if (!filteredStops.length) {
      showNotification("‚ö†Ô∏è No route stops found for this bus!");
      return;
    }

    filteredStops.forEach(stop => {
      const stopMarker = L.marker([stop.latitude, stop.longitude], {
        icon: L.icon({
          iconUrl: "/images/stop.png",
          iconSize: [32, 32],
          iconAnchor: [16, 32]
        })
      }).addTo(map);

      stopMarkers.push(stopMarker);
      stopMarker.bindPopup(`<b>${stop.stopName}</b>`);
    });

    const group = L.featureGroup(stopMarkers);
    map.fitBounds(group.getBounds().pad(0.2));
  }

  // ===========================
  // RESTORE LAST SELECTED BUS
  // ===========================
  window.addEventListener("load", () => {
    const savedBusId = localStorage.getItem("selectedBusId");
    if (savedBusId) {
      selectedBusId = savedBusId;
      busSelect.value = savedBusId;
      viewBtn.disabled = false;
      showStopsForBus(savedBusId);
      showNotification("üöç Tracking resumed!");
    }
  });

  // ===========================
  // BUS SELECTED
  // ===========================
  busSelect.onchange = (e) => {
    selectedBusId = e.target.value.trim();
    viewBtn.disabled = !selectedBusId;

    if (marker) map.removeLayer(marker);
    marker = null;
    clearStops();
  };

  // ===========================
  // VIEW BUTTON CLICK
  // ===========================
  viewBtn.onclick = () => {
    if (!selectedBusId) return;

    localStorage.setItem("selectedBusId", selectedBusId);
    showStopsForBus(selectedBusId);
    showNotification("üöç Tracking started!");
  };

  // ===========================
  // BUS ANIMATION
  // ===========================
  function animateBusMarker(marker, oldPos, newPos, duration = 1000) {
    let start = performance.now();

    function frame() {
      let time = performance.now();
      let progress = Math.min((time - start) / duration, 1);

      let currentLat = oldPos.lat + (newPos.lat - oldPos.lat) * progress;
      let currentLng = oldPos.lng + (newPos.lng - oldPos.lng) * progress;

      marker.setLatLng([currentLat, currentLng]);

      if (progress < 1) requestAnimationFrame(frame);
    }

    requestAnimationFrame(frame);
  }

  // ===========================
  // LIVE LOCATION LISTENER
  // ===========================
  socket.on("receive-location", ({ busId, latitude, longitude }) => {
    if (selectedBusId !== String(busId)) return;

    if (!marker) {
      marker = L.marker([latitude, longitude], {
        icon: L.icon({
          iconUrl: "/images/bus.png",
          iconSize: [45, 45],
          iconAnchor: [22, 22],
        })
      }).addTo(map);

    } else {
      const oldPos = marker.getLatLng();
      const newPos = L.latLng(latitude, longitude);

      animateBusMarker(marker, oldPos, newPos, 800);
    }

    map.setView([latitude, longitude], 15);
  });

  // ===========================
  // NOTIFICATION POPUP
  // ===========================
  function showNotification(text) {
    const msg = document.createElement("div");
    msg.innerHTML = text;
    msg.style.position = "fixed";
    msg.style.bottom = "20px";
    msg.style.right = "20px";
    msg.style.padding = "12px 18px";
    msg.style.background = "#00a5c6";
    msg.style.color = "white";
    msg.style.fontWeight = "600";
    msg.style.borderRadius = "12px";
    msg.style.boxShadow = "0 4px 12px rgba(0,0,0,0.3)";
    msg.style.zIndex = "9999";
    msg.style.transition = "opacity 0.4s";
    document.body.appendChild(msg);

    setTimeout(() => {
      msg.style.opacity = "0";
      setTimeout(() => msg.remove(), 500);
    }, 2700);
  }
</script>

<!-- BUS & STOP ICON UI -->
<style>
  .leaflet-marker-icon[src*="bus.png"] {
    border-radius: 50%;
    border: 3px solid white;
    background: radial-gradient(circle at 30% 30%, #00b4d8, #0077b6);
    padding: 4px;
    width: 46px !important;
    height: 46px !important;
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
  }

  .leaflet-marker-icon[src*="stop.png"] {
    border-radius: 50%;
    border: 2px solid white;
    background: radial-gradient(circle at 30% 30%, #ffd166, #fca311);
    padding: 3px;
    width: 34px !important;
    height: 34px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
</style>

<% } %>
