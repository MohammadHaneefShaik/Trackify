  <h2 class="title">Driver Dashboard</h2>

<div class="map-container">
  <div id="map" 
    data-stops='<%- JSON.stringify(stops || []) %>'>
  </div>
</div>

<div class="btn-row">
  <button id="startBtn" class="btn start">Start Trip</button>
  <button id="endBtn" class="btn end">End Trip</button>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Socket -->
<script src="/socket.io/socket.io.js"></script>

<style>
  /* Modern Page Title */
  .title {
    text-align: center;
    margin-top: 15px;
    font-weight: 700;
    color: #0a4d68;
    letter-spacing: 0.5px;
  }

  /* Map Outer Container */
  .map-container {
    margin-top: 20px;
    border-radius: 18px;
    padding: 8px;
    background: rgba(255, 255, 255, 0.45);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    backdrop-filter: blur(8px);
  }

  /* Map */
  #map {
    height: 430px;
    width: 100%;
    border-radius: 14px;
  }

  /* Buttons Row */
  .btn-row {
    margin-top: 18px;
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  /* Modern Buttons */
  .btn {
    padding: 12px 24px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    transition: 0.25s;
  }

  .btn.start {
    background: linear-gradient(135deg, #28a745, #3ecf5f);
  }

  .btn.start:hover {
    transform: scale(1.05);
  }

  .btn.end {
    background: linear-gradient(135deg, #d90429, #ef233c);
  }

  .btn.end:hover {
    transform: scale(1.05);
  }

  /* Bus Icon Style */
  .leaflet-marker-icon[src*="bus.png"] {
    border-radius: 50%;
    border: 3px solid white;
    background: radial-gradient(circle at 30% 30%, #00b4d8, #0077b6);
    padding: 4px;
    width: 46px !important;
    height: 46px !important;
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
    transition: transform .25s ease;
  }

  .leaflet-marker-icon[src*="bus.png"]:hover {
    transform: scale(1.12);
  }

  /* Stop icon */
  .leaflet-marker-icon[src*="stop.png"] {
    width: 32px !important;
    height: 32px !important;
    border-radius: 50%;
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  }
</style>

<script>
  const socket = io({ withCredentials: true });
  const busId = "<%= assignedBus %>";
  const stopsData = JSON.parse(document.getElementById("map").dataset.stops || "[]");

  if (!busId) {
    alert("âŒ No bus assigned. Contact Admin.");
  }

  // Initialize Map
  const map = L.map("map").setView([15.8281, 78.0373], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  const busIcon = L.icon({
    iconUrl: "/images/bus.png",
    iconSize: [45, 45],
    iconAnchor: [22, 22],
  });

  const stopIcon = L.icon({
    iconUrl: "/images/stop.png",
    iconSize: [28, 28],
    iconAnchor: [14, 28],
  });

  let marker, watchId;

  // Show all stops
  if (stopsData.length) {
    stopsData.forEach(stop => {
      L.marker([stop.latitude, stop.longitude], { icon: stopIcon })
        .addTo(map)
        .bindPopup(`<b>${stop.stopName}</b>`);
    });

    const group = L.featureGroup(
      stopsData.map(s => L.marker([s.latitude, s.longitude]))
    );
    map.fitBounds(group.getBounds().pad(0.2));
  }

  // Start Trip
  document.getElementById("startBtn").onclick = () => {
    if (!navigator.geolocation) {
      alert("âŒ GPS not supported by your browser");
      return;
    }

    watchId = navigator.geolocation.watchPosition(
      (pos) => {
        const { latitude: lat, longitude: lng } = pos.coords;

        socket.emit("send-location", { busId, latitude: lat, longitude: lng });

        if (!marker) {
          marker = L.marker([lat, lng], { icon: busIcon }).addTo(map);
        } else {
          marker.setLatLng([lat, lng]);
        }

        map.setView([lat, lng]);
      },
      (err) => alert("GPS Error: " + err.message),
      { enableHighAccuracy: true, maximumAge: 0 }
    );
  };

  // End Trip
  document.getElementById("endBtn").onclick = () => {
    if (watchId) navigator.geolocation.clearWatch(watchId);
    alert("ðŸ›‘ Trip Ended â€” Tracking Stopped");
    socket.disconnect();
  };
</script>
