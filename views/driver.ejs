<h3>Driver Dashboard</h3>  <div id="map" data-stops='<%- JSON.stringify(stops || []) %>'  
  style="height: 400px; width: 100%; margin-top: 10px; border-radius: 12px; border: 1px solid #ccc;">  
</div>  <button id="startBtn" class="btn btn-primary mt-3">Start Trip</button>
<button id="endBtn" class="btn btn-danger mt-3">End Trip</button>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />  
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>  
<script src="/socket.io/socket.io.js"></script>  <style>  
  /* ðŸšŒ Rounded Bus Icon */  
  .leaflet-marker-icon[src*="bus.png"] {  
    border-radius: 50%;  
    border: 3px solid white;  
    background: radial-gradient(circle at 30% 30%, #00b4d8, #0077b6);  
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);  
    padding: 4px;  
    object-fit: cover;  
    width: 46px !important;  
    height: 46px !important;  
    transition: transform 0.3s ease, box-shadow 0.3s ease;  
  }  
  
  .leaflet-marker-icon[src*="bus.png"]:hover {  
    transform: scale(1.1);  
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);  
  }  
</style>  <script>  
  const socket = io({ withCredentials: true });  
  const busId = "<%= assignedBus %>";  
  const stopsData = JSON.parse(document.getElementById("map").dataset.stops || "[]");  
  
  if (!busId) {  
    alert("âŒ No bus assigned. Contact Admin.");  
  }  
  
  // Initialize Map  
  const map = L.map("map").setView([15.8281, 78.0373], 12);  
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);  
  
  const busIcon = L.icon({  
    iconUrl: "/images/bus.png",  
    iconSize: [45, 45],  
    iconAnchor: [22, 22],  
  });  
  
  const stopIcon = L.icon({  
    iconUrl: "/images/stop.png",  
    iconSize: [28, 28],  
    iconAnchor: [14, 28],  
  });  
  
  let marker, watchId;  
  
  // ðŸ›‘ Show all stops for this bus  
  if (stopsData.length) {  
    stopsData.forEach(stop => {  
      L.marker([stop.latitude, stop.longitude], { icon: stopIcon })  
        .addTo(map)  
        .bindPopup(`<b>${stop.stopName}</b>`);  
    });  
    const group = L.featureGroup(  
      stopsData.map(s => L.marker([s.latitude, s.longitude]))  
    );  
    map.fitBounds(group.getBounds().pad(0.2));  
  }  
  
  // ðŸ§­ Start tracking  
  document.getElementById("startBtn").onclick = () => {  
    if (!navigator.geolocation) {  
      alert("âŒ GPS not supported by your browser");  
      return;  
    }  
  
    watchId = navigator.geolocation.watchPosition(  
      (pos) => {  
        const lat = pos.coords.latitude;  
        const lng = pos.coords.longitude;  
  
        socket.emit("send-location", { busId, latitude: lat, longitude: lng });  
  
        if (!marker) {  
          marker = L.marker([lat, lng], { icon: busIcon }).addTo(map);  
        } else {  
          marker.setLatLng([lat, lng]);  
        }  
  
        map.setView([lat, lng]);  
      },  
      (err) => alert("GPS error: " + err.message),  
      { enableHighAccuracy: true, maximumAge: 0 }  
    );  
  };  
  
  // ðŸ›‘ End trip  
  document.getElementById("endBtn").onclick = () => {  
    if (watchId) navigator.geolocation.clearWatch(watchId);  
    alert("ðŸ›‘ Trip Ended â€” tracking stopped");  
    socket.disconnect();  
  };  
</script> 

